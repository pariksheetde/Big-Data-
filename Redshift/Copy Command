-------------------------------------------------------LOAD DATA FROM S3 INTO REDSHIFT----------------------------------------------------------------------------
------------------------------------------------------------DEPARTMENTS TABLE-------------------------------------------------------------------------------------

CREATE TABLE departments
(
dept_id int,
dept_nm varchar(50),
loc_id int
);

# load departments.csv from s3 into departments table

copy departments (dept_id, dept_nm, loc_id)
from 's3://humanresource-lake/departments/departments.csv'
credentials 'aws_iam_role=arn:aws:iam::265475006349:role/RedshiftRole'
FORMAT AS CSV
region 'ap-south-1'
IGNOREHEADER 1

--------------------------------------------------------------------LOCATIONS TABLE-----------------------------------------------------------------------------

CREATE TABLE locations
(
location_id INTEGER NOT NULL,
location_name VARCHAR(20)
)

# load locations_cp.csv from s3 into departments table

copy locations (location_id, location_name)
from 's3://humanresource-lake/departments/locations_cp.csv'
credentials 'aws_iam_role=arn:aws:iam::265475006349:role/RedshiftRole'
FORMAT AS CSV
region 'ap-south-1'
IGNOREHEADER 1

----------------------------------------------------------------------SQL STATEMENT START----------------------------------------------------------------------------

SELECT
l.location_id,
d.dept_id,
d.dept_nm,
l.location_name
FROM
locations l join departments d
on l.location_id = d.loc_id;

----------------------------------------------------------------------SQL STATEMENT END-------------------------------------------------------------------------------

# CREATE EXTERNAL SCHEMA & DATABASE FOR REDSHIFT SPECTRUM

CREATE EXTERNAL SCHEMA spectrum
from data catalog
database 'hrdb'
iam_role 'arn:aws:iam::265475006349:role/RedshiftRole'
create external database if not exists;

SET AUTOCOMMIT = ON;
CREATE EXTERNAL TABLE spectrum.customers
(
Emp_ID	int,
F_Name varchar(30),
L_Name varchar(30),
Dept_ID int,
Salary numeric(15,3),
Manager_ID int
)
row format delimited
fields terminated by ','
STORED AS TEXTFILE
location 's3://customersdatalake/customer/';

---------------------------------------------------------------SQL QUERY FROM REDSHIFT & SPECTRUM---------------------------------------------------------------------

SELECT
c.emp_id,
c.f_name||' '||c.l_name AS cust_name,
l.loc_id,
d.dept_id,
d.dept_nm,
l.loc_nm
FROM
locations l JOIN departments d
ON l.loc_id = d.loc_id JOIN spectrum.customers c
ON c.dept_id = d.dept_id;

------------------------------------------------------------------------END-------------------------------------------------------------------------------------------
